---
import './NoteList.css';

interface NoteArticle {
  id: number;
  name: string;
  eyecatch: string;
  publishAt: string;
  noteUrl: string;
  description: string;
  likeCount: number;
  hashtags: string[];
}

const currentPage = Number(Astro.url.searchParams.get('page')) || 1;

let articles: NoteArticle[] = [];
let error = '';
let hasMore = false;

try {
  const response = await fetch(`https://note.com/api/v2/creators/entersight/contents?kind=note&page=${currentPage}`);
  const data = await response.json();

  if (data.data && data.data.contents) {
    articles = data.data.contents.map((article: any) => ({
      id: article.id,
      name: article.name,
      eyecatch: article.eyecatch,
      publishAt: article.publishAt,
      noteUrl: `https://note.com/entersight/n/${article.key}`,
      description: article.body || '',
      likeCount: article.likeCount || 0,
      hashtags: (article.hashtags || []).map((h: any) => h.hashtag?.name || '')
    }));

    hasMore = data.data.isLastPage === false;
  }
} catch (e) {
  error = 'note記事の取得に失敗しました';
  console.error(e);
}
---

<div class="note-list-container">
  <div class="note-list-header">
    <h1>Note</h1>
    <p class="description">最新記事一覧</p>
  </div>

  {error && <p class="error-message">{error}</p>}

  {articles.length > 0 ? (
    <>
      <div class="note-grid">
        {articles.map((article) => (
          <a href={article.noteUrl} target="_blank" rel="noopener noreferrer" class="note-card">
            <div class="note-card-image">
              <img src={article.eyecatch} alt={article.name} />
            </div>
            <div class="note-card-content">
              <h4 class="note-card-title">{article.name}</h4>
              <p class="note-card-description">{article.description}</p>
              {article.hashtags.length > 0 && (
                <div class="note-card-hashtags">
                  {article.hashtags.map((tag) => (
                    <span class="hashtag">{tag}</span>
                  ))}
                </div>
              )}
              <div class="note-card-footer">
                <p class="note-card-date">
                  {new Date(article.publishAt).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </p>
                {article.likeCount > 0 && (
                  <p class="note-card-likes">♥ {article.likeCount}</p>
                )}
              </div>
            </div>
          </a>
        ))}
      </div>

      <div class="pagination">
        {currentPage > 1 && (
          <a href={`/note?page=${currentPage - 1}`} class="pagination-button">
            ← 前のページ
          </a>
        )}
        <span class="pagination-current">ページ {currentPage}</span>
        {hasMore && (
          <a href={`/note?page=${currentPage + 1}`} class="pagination-button">
            次のページ →
          </a>
        )}
      </div>
    </>
  ) : (
    <div class="note-placeholder">
      <p>記事を読み込み中...</p>
    </div>
  )}
</div>